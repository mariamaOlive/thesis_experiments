from typing import Annotated
from semantic_kernel.functions.kernel_function_decorator import kernel_function

class PromptPlugin:
    def __init__(self, initial_instruction: str = ""):
        self.best_instruction: str = initial_instruction
        self.last_instruction: str = initial_instruction
        self.best_rouge_score: float = 0.0
        self.last_summary: str = ""

    @kernel_function(
        name="get_best_instruction",
        description="Retrieve the best summarization instruction created so far by the Teacher."
    )
    async def get_best_instruction(self) -> Annotated[str, "Best instruction so far created so far by the Teacher"]:
        return self.best_instruction

    @kernel_function(
        name="get_best_instruction_rouge_score",
        description="Get the ROUGE score associated with the best instruction so far."
    )
    async def get_best_instruction_rouge_score(self) -> Annotated[float, "ROUGE score of best instruction"]:
        return self.best_rouge_score

    @kernel_function(
        name="get_last_summary",
        description="Retrieve the most recent summary produced by the Summarizer."
    )
    async def get_last_summary(self) -> Annotated[str, "Most recent summary produced by the Summarizer"]:
        return self.last_summary

    @kernel_function(
        name="set_last_summary",
        description="Set or update the most recent summary generated by the Summarizer."
    )
    async def set_last_summary(
        self,
        summary: Annotated[str, "The latest summary to store"]
    ) -> Annotated[str, "Acknowledgement of update"]:
        self.last_summary = summary
        return "✅ Last summary updated."

    @kernel_function(
        name="get_last_instruction",
        description="Retrieve the most recent instruction proposed by the Teacher."
    )
    async def get_last_instruction(self) -> Annotated[str, "Last instruction proposed"]:
        return self.last_instruction

    @kernel_function(
        name="set_last_instruction",
        description="Set or update the most recent instruction proposed by the Teacher."
    )
    async def set_last_instruction(
        self,
        instruction: Annotated[str, "New instruction to consider"]
    ) -> Annotated[str, "Acknowledgement of update"]:
        self.last_instruction = instruction
        return "✅ Last instruction updated."

    @kernel_function(
        name="update_best_instruction",
        description="Update the best instruction only if it achieves a higher ROUGE score."
    )
    async def update_best_instruction(
        self,
        new_instruction: Annotated[str, "Candidate instruction to evaluate"],
        rouge_score: Annotated[float, "ROUGE score of the candidate instruction"]
    ) -> Annotated[str, "Result of update attempt"]:
        if rouge_score > self.best_rouge_score:
            self.best_instruction = new_instruction
            self.best_rouge_score = rouge_score
            return f"✅ Best instruction updated with ROUGE score {rouge_score:.4f}"
        return f"ℹ️ ROUGE score {rouge_score:.4f} did not exceed the best score {self.best_rouge_score:.4f}"
